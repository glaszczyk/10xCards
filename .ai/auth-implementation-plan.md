# Plan Implementacji Autoryzacji Supabase Auth - 10xCards

## üìã Analiza IstniejƒÖcego Stanu

### ‚úÖ Co jest ju≈º zaimplementowane:

- Supabase Client (`src/db/supabase.client.ts`)
- Podstawowy Auth Context (`src/lib/auth.tsx`)
- Middleware z ochronƒÖ tras (`src/middleware/index.ts`)
- UI komponenty (LoginForm, RegisterForm)
- Typy bazy danych (`src/db/database.types.ts`)

### üîÑ Co wymaga implementacji:

- Konfiguracja projektu Supabase
- Tabela `profiles` z RLS
- Magic Link authentication
- Reset has≈Ça
- Weryfikacja email
- Integracja UI z backend
- Rozszerzenie middleware

---

## üöÄ FAZA 1: Konfiguracja Supabase (1-2 godziny)

### Krok 1.1: Utworzenie projektu Supabase

1. Przejd≈∫ do [supabase.com](https://supabase.com)
2. Kliknij "New Project"
3. Wybierz organizacjƒô lub utw√≥rz nowƒÖ
4. Wprowad≈∫ nazwƒô projektu: `10xcards`
5. Ustaw has≈Ço do bazy danych (zapisz je!)
6. Wybierz region (najbli≈ºszy u≈ºytkownikom)
7. Kliknij "Create new project"

### Krok 1.2: Konfiguracja Authentication

1. W dashboardzie przejd≈∫ do **Authentication** ‚Üí **Settings**
2. W sekcji **Site URL** ustaw: `http://localhost:4321`
3. W **Redirect URLs** dodaj:
   - `http://localhost:4321/auth/callback`
   - `http://localhost:4321/auth/reset-password`
4. W≈ÇƒÖcz **Enable email confirmations**
5. W≈ÇƒÖcz **Enable magic link authentication**

### Krok 1.3: Konfiguracja Email Templates

1. Przejd≈∫ do **Authentication** ‚Üí **Email Templates**
2. Dostosuj **Confirm signup** template:
   - Tytu≈Ç: "Potwierd≈∫ sw√≥j email - 10xCards"
   - Tre≈õƒá: Dodaj logo i link do aplikacji
3. Dostosuj **Magic Link** template:
   - Tytu≈Ç: "Zaloguj siƒô do 10xCards"
   - Tre≈õƒá: Kr√≥tkie wyja≈õnienie magic link
4. Dostosuj **Reset Password** template:
   - Tytu≈Ç: "Reset has≈Ça - 10xCards"
   - Tre≈õƒá: Instrukcje resetowania

### Krok 1.4: Pobranie kluczy API

1. W **Settings** ‚Üí **API** znajd≈∫:
   - **Project URL** (np. `https://abc123.supabase.co`)
   - **anon public key** (klucz zaczynajƒÖcy siƒô od `eyJ...`)
2. Skopiuj te warto≈õci - bƒôdƒÖ potrzebne w nastƒôpnym kroku

---

## üóÑÔ∏è FAZA 2: Konfiguracja Bazy Danych (2-3 godziny)

### Krok 2.1: Utworzenie tabeli `profiles`

1. W dashboardzie przejd≈∫ do **SQL Editor**
2. Utw√≥rz nowy query i wykonaj:

```sql
-- Tabela profiles dla dodatkowych danych u≈ºytkownika
CREATE TABLE public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    full_name TEXT,
    avatar_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- W≈ÇƒÖcz Row Level Security
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Polityki RLS - u≈ºytkownicy widzƒÖ tylko sw√≥j profil
CREATE POLICY "Users can view own profile" ON public.profiles
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON public.profiles
    FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile" ON public.profiles
    FOR INSERT WITH CHECK (auth.uid() = id);

-- Trigger automatycznie tworzy profil po rejestracji
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, email)
    VALUES (NEW.id, NEW.email);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

### Krok 2.2: Aktualizacja istniejƒÖcych tabel

1. W tym samym query dodaj:

```sql
-- Dodaj user_id do source_texts (je≈õli nie ma)
ALTER TABLE public.source_texts ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;

-- W≈ÇƒÖcz RLS dla source_texts
ALTER TABLE public.source_texts ENABLE ROW LEVEL SECURITY;

-- Polityki RLS dla source_texts
CREATE POLICY "Users can view own source texts" ON public.source_texts
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own source texts" ON public.source_texts
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own source texts" ON public.source_texts
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own source texts" ON public.source_texts
    FOR DELETE USING (auth.uid() = user_id);

-- Upewnij siƒô, ≈ºe flashcards te≈º majƒÖ RLS
ALTER TABLE public.flashcards ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own flashcards" ON public.flashcards
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own flashcards" ON public.flashcards
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own flashcards" ON public.flashcards
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own flashcards" ON public.flashcards
    FOR DELETE USING (auth.uid() = user_id);
```

### Krok 2.3: Aktualizacja typ√≥w TypeScript

1. W terminalu wykonaj: `npm run update-types`
2. Sprawd≈∫ czy w `src/db/database.types.ts` pojawi≈Ça siƒô tabela `profiles`
3. Je≈õli nie, dodaj rƒôcznie:

```typescript
// Dodaj do Database.public.Tables
profiles: {
  Row: {
    id: string
    email: string
    full_name: string | null
    avatar_url: string | null
    created_at: string
    updated_at: string
  }
  Insert: {
    id: string
    email: string
    full_name?: string | null
    avatar_url?: string | null
    created_at?: string
    updated_at?: string
  }
  Update: {
    id?: string
    email?: string
    full_name?: string | null
    avatar_url?: string | null
    created_at?: string
    updated_at?: string
  }
  Relationships: [
    {
      foreignKeyName: "profiles_id_fkey"
      columns: ["id"]
      referencedRelation: "users"
      referencedColumns: ["id"]
    }
  ]
}
```

---

## ‚öôÔ∏è FAZA 3: Konfiguracja ≈örodowiska (30 minut)

### Krok 3.1: Utworzenie pliku `.env`

1. W g≈Ç√≥wnym katalogu projektu utw√≥rz plik `.env`
2. Dodaj konfiguracjƒô:

```bash
# Supabase Configuration
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key_here

# Data Provider
DATA_PROVIDER=supabase

# Development settings
NODE_ENV=development
```

3. ZastƒÖp `your-project.supabase.co` i `your_anon_key_here` warto≈õciami z kroku 1.4

### Krok 3.2: Aktualizacja `env.example`

1. Otw√≥rz `env.example`
2. Zaktualizuj komentarze:

```bash
# Supabase Configuration
# Get these values from your Supabase project dashboard
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key_here

# Data Provider Configuration
# Options: 'supabase', 'mock', or leave empty for auto-detection
DATA_PROVIDER=supabase
```

### Krok 3.3: Sprawdzenie konfiguracji

1. Uruchom aplikacjƒô: `npm run dev`
2. Sprawd≈∫ w konsoli przeglƒÖdarki czy nie ma b≈Çƒôd√≥w Supabase
3. Sprawd≈∫ w Network tab czy sƒÖ po≈ÇƒÖczenia z Supabase

---

## üîß FAZA 4: Rozszerzenie Auth Helpers (2-3 godziny)

### Krok 4.1: Aktualizacja typ√≥w AuthSession

1. Otw√≥rz `src/types/index.ts`
2. Zaktualizuj interfejs `AuthSession`:

```typescript
export interface AuthSession {
  user: User | null;
  profile: Profile | null; // Nowe pole
  isLoading: boolean;
  isAuthenticated: boolean;
  refreshProfile: () => Promise<void>; // Nowa funkcja
}

export interface Profile {
  id: string;
  email: string;
  full_name: string | null;
  avatar_url: string | null;
  created_at: string;
  updated_at: string;
}
```

### Krok 4.2: Rozszerzenie funkcji auth w `src/lib/auth.tsx`

1. Dodaj nowe funkcje na ko≈Ñcu pliku:

```typescript
// Magic Link authentication
export async function signInWithMagicLink(email: string) {
  const { data, error } = await supabaseClient.auth.signInWithOtp({
    email,
    options: {
      emailRedirectTo: `${window.location.origin}/auth/callback`,
    },
  });

  if (error) throw new Error(error.message);
  return data;
}

// Reset password
export async function resetPassword(email: string) {
  const { data, error } = await supabaseClient.auth.resetPasswordForEmail(
    email,
    {
      redirectTo: `${window.location.origin}/auth/reset-password`,
    }
  );

  if (error) throw new Error(error.message);
  return data;
}

// Update password
export async function updatePassword(newPassword: string) {
  const { data, error } = await supabaseClient.auth.updateUser({
    password: newPassword,
  });

  if (error) throw new Error(error.message);
  return data;
}

// Get user profile
export async function getUserProfile(userId: string) {
  const { data, error } = await supabaseClient
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .single();

  if (error) throw new Error(error.message);
  return data;
}

// Update user profile
export async function updateUserProfile(
  userId: string,
  updates: Partial<Profile>
) {
  const { data, error } = await supabaseClient
    .from("profiles")
    .update(updates)
    .eq("id", userId)
    .select()
    .single();

  if (error) throw new Error(error.message);
  return data;
}
```

### Krok 4.3: Aktualizacja AuthContext

1. Zaktualizuj `AuthProvider` w `src/lib/auth.tsx`:

```typescript
export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  // Funkcja do od≈õwie≈ºania profilu
  const refreshProfile = async () => {
    if (user) {
      try {
        const profileData = await getUserProfile(user.id);
        setProfile(profileData);
      } catch (error) {
        console.error("Error fetching profile:", error);
        setProfile(null);
      }
    }
  };

  useEffect(() => {
    // Get initial session
    supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
      setUser(session?.user ?? null);
      if (session?.user) {
        await refreshProfile();
      }
      setIsLoading(false);
    });

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabaseClient.auth.onAuthStateChange(async (_event, session) => {
      setUser(session?.user ?? null);
      if (session?.user) {
        await refreshProfile();
      } else {
        setProfile(null);
      }
      setIsLoading(false);
    });

    return () => subscription.unsubscribe();
  }, []);

  const value: AuthSession = {
    user,
    profile,
    isLoading,
    isAuthenticated: !!user,
    refreshProfile,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}
```

---

## üîó FAZA 5: Implementacja Magic Link (1-2 godziny)

### Krok 5.1: Utworzenie strony callback

1. Utw√≥rz plik `src/pages/auth/callback.astro`:

```astro
---
// Obs≈Çuga callback z magic link i reset password
import { supabaseClient } from "@/db/supabase.client";

const url = new URL(Astro.request.url);
const accessToken = url.searchParams.get("access_token");
const refreshToken = url.searchParams.get("refresh_token");
const type = url.searchParams.get("type");

let message = "";
let isSuccess = false;

if (accessToken && refreshToken) {
  try {
    // Ustaw sesjƒô
    const { data, error } = await supabaseClient.auth.setSession({
      access_token: accessToken,
      refresh_token: refreshToken,
    });

    if (error) {
      message = "B≈ÇƒÖd autoryzacji: " + error.message;
    } else {
      isSuccess = true;
      if (type === "recovery") {
        message = "Has≈Ço zosta≈Ço zresetowane. Mo≈ºesz siƒô teraz zalogowaƒá.";
      } else {
        message = "Zalogowano pomy≈õlnie! Przekierowywanie...";
      }
    }
  } catch (error) {
    message = "WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd.";
  }
} else {
  message = "Nieprawid≈Çowy link autoryzacji.";
}

// Przekierowanie po 3 sekundach
if (isSuccess) {
  setTimeout(() => {
    window.location.href = "/generate";
  }, 3000);
}
---

<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Autoryzacja - 10xCards</title>
</head>
<body>
  <div class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="max-w-md w-full space-y-8">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-gray-900">
          {isSuccess ? "Sukces!" : "B≈ÇƒÖd"}
        </h2>
        <p class="mt-2 text-gray-600">{message}</p>
        {isSuccess && (
          <div class="mt-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
            <p class="text-sm text-gray-500 mt-2">Przekierowywanie...</p>
          </div>
        )}
      </div>
    </div>
  </div>
</body>
</html>
```

### Krok 5.2: Dodanie Magic Link do LoginForm

1. Otw√≥rz `src/components/auth/LoginForm.tsx`
2. Dodaj stan dla magic link:

```typescript
const [showMagicLink, setShowMagicLink] = useState(false);
const [magicLinkEmail, setMagicLinkEmail] = useState("");
const [magicLinkStatus, setMagicLinkStatus] = useState<
  "idle" | "loading" | "success" | "error"
>("idle");
```

3. Dodaj funkcjƒô obs≈Çugi magic link:

```typescript
const handleMagicLink = async (e: React.FormEvent) => {
  e.preventDefault();
  if (!magicLinkEmail) return;

  setMagicLinkStatus("loading");
  try {
    await signInWithMagicLink(magicLinkEmail);
    setMagicLinkStatus("success");
    setMagicLinkEmail("");
  } catch (error) {
    setMagicLinkStatus("error");
  }
};
```

4. Dodaj UI dla magic link w komponencie:

```tsx
{
  /* Magic Link Section */
}
<div className="mt-6">
  <button
    type="button"
    onClick={() => setShowMagicLink(!showMagicLink)}
    className="text-sm text-blue-600 hover:text-blue-500"
  >
    {showMagicLink ? "Ukryj" : "Zaloguj siƒô magic linkiem"}
  </button>

  {showMagicLink && (
    <form onSubmit={handleMagicLink} className="mt-4 space-y-4">
      <div>
        <label
          htmlFor="magic-email"
          className="block text-sm font-medium text-gray-700"
        >
          Email
        </label>
        <input
          id="magic-email"
          type="email"
          value={magicLinkEmail}
          onChange={(e) => setMagicLinkEmail(e.target.value)}
          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          placeholder="tw√≥j@email.com"
          required
        />
      </div>

      <button
        type="submit"
        disabled={magicLinkStatus === "loading"}
        className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
      >
        {magicLinkStatus === "loading" ? "Wysy≈Çanie..." : "Wy≈õlij magic link"}
      </button>

      {magicLinkStatus === "success" && (
        <p className="text-sm text-green-600 text-center">
          Magic link zosta≈Ç wys≈Çany! Sprawd≈∫ sw√≥j email.
        </p>
      )}

      {magicLinkStatus === "error" && (
        <p className="text-sm text-red-600 text-center">
          WystƒÖpi≈Ç b≈ÇƒÖd. Spr√≥buj ponownie.
        </p>
      )}
    </form>
  )}
</div>;
```

---

## üîê FAZA 6: Implementacja Reset Password (2-3 godziny)

### Krok 6.1: Strona "Zapomnia≈Çem has≈Ça"

1. Utw√≥rz plik `src/pages/auth/forgot-password.astro`:

```astro
---
// Strona do wys≈Çania linku resetowania has≈Ça
---

<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zapomnia≈Çe≈õ has≈Ça - 10xCards</title>
</head>
<body>
  <div class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="max-w-md w-full space-y-8">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-gray-900">
          Zapomnia≈Çe≈õ has≈Ça?
        </h2>
        <p class="mt-2 text-gray-600">
          Wprowad≈∫ sw√≥j email, a wy≈õlemy Ci link do resetowania has≈Ça.
        </p>
      </div>

      <div id="forgot-password-form" class="mt-8 space-y-6">
        <!-- React component will be mounted here -->
      </div>

      <div class="text-center">
        <a href="/auth/login" class="text-sm text-blue-600 hover:text-blue-500">
          Wr√≥ƒá do logowania
        </a>
      </div>
    </div>
  </div>

  <script>
    import { ForgotPasswordForm } from "@/components/auth/ForgotPasswordForm";
    import { createRoot } from "react-dom/client";

    const container = document.getElementById("forgot-password-form");
    if (container) {
      const root = createRoot(container);
      root.render(ForgotPasswordForm());
    }
  </script>
</body>
</html>
```

### Krok 6.2: Komponent ForgotPasswordForm

1. Utw√≥rz plik `src/components/auth/ForgotPasswordForm.tsx`:

```tsx
import React, { useState } from "react";
import { resetPassword } from "@/lib/auth";

export function ForgotPasswordForm() {
  const [email, setEmail] = useState("");
  const [status, setStatus] = useState<
    "idle" | "loading" | "success" | "error"
  >("idle");
  const [errorMessage, setErrorMessage] = useState("");

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!email) return;

    setStatus("loading");
    setErrorMessage("");

    try {
      await resetPassword(email);
      setStatus("success");
    } catch (error) {
      setStatus("error");
      setErrorMessage(error instanceof Error ? error.message : "WystƒÖpi≈Ç b≈ÇƒÖd");
    }
  };

  if (status === "success") {
    return (
      <div className="text-center">
        <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
          <svg
            className="h-6 w-6 text-green-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M5 13l4 4L19 7"
            />
          </svg>
        </div>
        <h3 className="mt-4 text-lg font-medium text-gray-900">
          Email wys≈Çany!
        </h3>
        <p className="mt-2 text-sm text-gray-600">
          Sprawd≈∫ swojƒÖ skrzynkƒô email. Link do resetowania has≈Ça zosta≈Ç
          wys≈Çany.
        </p>
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div>
        <label
          htmlFor="email"
          className="block text-sm font-medium text-gray-700"
        >
          Adres email
        </label>
        <input
          id="email"
          name="email"
          type="email"
          autoComplete="email"
          required
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          placeholder="tw√≥j@email.com"
        />
      </div>

      {status === "error" && (
        <div className="text-sm text-red-600 text-center">{errorMessage}</div>
      )}

      <button
        type="submit"
        disabled={status === "loading"}
        className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
      >
        {status === "loading" ? "Wysy≈Çanie..." : "Wy≈õlij link resetowania"}
      </button>
    </form>
  );
}
```

### Krok 6.3: Strona resetowania has≈Ça

1. Utw√≥rz plik `src/pages/auth/reset-password.astro`:

```astro
---
// Strona do ustawienia nowego has≈Ça
---

<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset has≈Ça - 10xCards</title>
</head>
<body>
  <div class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="max-w-md w-full space-y-8">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-gray-900">
          Ustaw nowe has≈Ço
        </h2>
        <p class="mt-2 text-gray-600">
          Wprowad≈∫ nowe has≈Ço dla swojego konta.
        </p>
      </div>

      <div id="reset-password-form" class="mt-8 space-y-6">
        <!-- React component will be mounted here -->
      </div>
    </div>
  </div>

  <script>
    import { ResetPasswordForm } from "@/components/auth/ResetPasswordForm";
    import { createRoot } from "react-dom/client";

    const container = document.getElementById("reset-password-form");
    if (container) {
      const root = createRoot(container);
      root.render(ResetPasswordForm());
    }
  </script>
</body>
</html>
```

### Krok 6.4: Komponent ResetPasswordForm

1. Utw√≥rz plik `src/components/auth/ResetPasswordForm.tsx`:

```tsx
import React, { useState } from "react";
import { updatePassword } from "@/lib/auth";

export function ResetPasswordForm() {
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [status, setStatus] = useState<
    "idle" | "loading" | "success" | "error"
  >("idle");
  const [errorMessage, setErrorMessage] = useState("");

  const validatePassword = (password: string) => {
    if (password.length < 8) return "Has≈Ço musi mieƒá co najmniej 8 znak√≥w";
    if (!/[A-Z]/.test(password)) return "Has≈Ço musi zawieraƒá wielkƒÖ literƒô";
    if (!/[a-z]/.test(password)) return "Has≈Ço musi zawieraƒá ma≈ÇƒÖ literƒô";
    if (!/[0-9]/.test(password)) return "Has≈Ço musi zawieraƒá cyfrƒô";
    return null;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (password !== confirmPassword) {
      setErrorMessage("Has≈Ça nie sƒÖ identyczne");
      return;
    }

    const passwordError = validatePassword(password);
    if (passwordError) {
      setErrorMessage(passwordError);
      return;
    }

    setStatus("loading");
    setErrorMessage("");

    try {
      await updatePassword(password);
      setStatus("success");
    } catch (error) {
      setStatus("error");
      setErrorMessage(error instanceof Error ? error.message : "WystƒÖpi≈Ç b≈ÇƒÖd");
    }
  };

  if (status === "success") {
    return (
      <div className="text-center">
        <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
          <svg
            className="h-6 w-6 text-green-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M5 13l4 4L19 7"
            />
          </svg>
        </div>
        <h3 className="mt-4 text-lg font-medium text-gray-900">
          Has≈Ço zaktualizowane!
        </h3>
        <p className="mt-2 text-sm text-gray-600">
          Twoje has≈Ço zosta≈Ço zmienione. Mo≈ºesz siƒô teraz zalogowaƒá.
        </p>
        <div className="mt-4">
          <a
            href="/auth/login"
            className="text-sm text-blue-600 hover:text-blue-500"
          >
            Przejd≈∫ do logowania
          </a>
        </div>
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div>
        <label
          htmlFor="password"
          className="block text-sm font-medium text-gray-700"
        >
          Nowe has≈Ço
        </label>
        <input
          id="password"
          name="password"
          type="password"
          autoComplete="new-password"
          required
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          placeholder="Nowe has≈Ço"
        />
      </div>

      <div>
        <label
          htmlFor="confirm-password"
          className="block text-sm font-medium text-gray-700"
        >
          Potwierd≈∫ nowe has≈Ço
        </label>
        <input
          id="confirm-password"
          name="confirm-password"
          type="password"
          autoComplete="new-password"
          required
          value={confirmPassword}
          onChange={(e) => setConfirmPassword(e.target.value)}
          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          placeholder="Potwierd≈∫ nowe has≈Ço"
        />
      </div>

      {errorMessage && (
        <div className="text-sm text-red-600 text-center">{errorMessage}</div>
      )}

      <button
        type="submit"
        disabled={status === "loading"}
        className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
      >
        {status === "loading" ? "Aktualizowanie..." : "Zmie≈Ñ has≈Ço"}
      </button>
    </form>
  );
}
```

---

## üîó FAZA 7: Integracja UI z Backend (3-4 godziny)

### Krok 7.1: Aktualizacja LoginForm

1. Otw√≥rz `src/components/auth/LoginForm.tsx`
2. ZastƒÖp mock implementacjƒô w `handleSubmit`:

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();

  if (!validateForm()) return;

  setState((prev) => ({ ...prev, status: "loading", error: null }));

  try {
    const { data } = await signIn(
      state.formData.email,
      state.formData.password
    );

    if (data.user) {
      setState((prev) => ({ ...prev, status: "success" }));
      if (onSuccess) onSuccess();
    }
  } catch (error) {
    setState((prev) => ({
      ...prev,
      status: "error",
      error:
        error instanceof Error ? error.message : "Logowanie nie powiod≈Ço siƒô",
    }));
  }
};
```

3. Dodaj link do resetowania has≈Ça:

```tsx
{
  /* Link do resetowania has≈Ça */
}
<div className="text-sm text-center">
  <a href="/auth/forgot-password" className="text-blue-600 hover:text-blue-500">
    Zapomnia≈Çe≈õ has≈Ça?
  </a>
</div>;
```

### Krok 7.2: Aktualizacja RegisterForm

1. Otw√≥rz `src/components/auth/RegisterForm.tsx`
2. ZastƒÖp mock implementacjƒô w `handleSubmit`:

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();

  if (!validateForm()) return;

  setState((prev) => ({ ...prev, status: "loading", error: null }));

  try {
    const { data } = await signUp(
      state.formData.email,
      state.formData.password
    );

    if (data.user) {
      setState((prev) => ({ ...prev, status: "success" }));
      // Poka≈º komunikat o weryfikacji email
      if (onSuccess) onSuccess();
    }
  } catch (error) {
    setState((prev) => ({
      ...prev,
      status: "error",
      error:
        error instanceof Error ? error.message : "Rejestracja nie powiod≈Ça siƒô",
    }));
  }
};
```

3. Zaktualizuj komunikat sukcesu:

```tsx
{
  state.status === "success" && (
    <div className="text-sm text-green-600 text-center">
      Konto zosta≈Ço utworzone! Sprawd≈∫ sw√≥j email, aby potwierdziƒá rejestracjƒô.
    </div>
  );
}
```

### Krok 7.3: Aktualizacja UserMenu

1. Otw√≥rz `src/components/shared/UserMenu.tsx`
2. Dodaj funkcjƒô wylogowania:

```typescript
import { signOut } from "@/lib/auth";

// W komponencie dodaj:
const handleSignOut = async () => {
  try {
    await signOut();
    // Przekierowanie nastƒÖpi automatycznie przez middleware
  } catch (error) {
    console.error("B≈ÇƒÖd wylogowania:", error);
  }
};

// W menu dodaj przycisk:
<button
  onClick={handleSignOut}
  className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
>
  Wyloguj siƒô
</button>
```

---

## üõ°Ô∏è FAZA 8: Aktualizacja Middleware (1-2 godziny)

### Krok 8.1: Aktualizacja ≈õcie≈ºek publicznych

1. Otw√≥rz `src/middleware/index.ts`
2. Zaktualizuj `publicPaths`:

```typescript
const publicPaths = [
  "/",
  "/auth/login",
  "/auth/register",
  "/auth/forgot-password",
  "/auth/reset-password",
  "/auth/callback",
  "/api",
  "/about",
];

// Dodaj funkcjƒô sprawdzajƒÖcƒÖ ≈õcie≈ºki auth
const isAuthPath = (pathname: string) => {
  return pathname.startsWith("/auth/");
};

const isPublicPath = (pathname: string) => {
  return publicPaths.some(
    (path) => pathname === path || pathname.startsWith(path + "/")
  );
};
```

### Krok 8.2: Logika przekierowa≈Ñ

1. Zaktualizuj logikƒô w `onRequest`:

```typescript
export const onRequest = defineMiddleware(
  async (
    {
      locals,
      request,
      redirect,
    }: { locals: App.Locals; request: Request; redirect: Function },
    next
  ) => {
    (locals as any).supabase = supabaseClient;
    (locals as any).user = null;
    (locals as any).session = null;

    const {
      data: { session },
    } = await supabaseClient.auth.getSession();

    if (session) {
      (locals as any).user = session.user;
      (locals as any).session = session;
    }

    const url = new URL(request.url);
    const pathname = url.pathname;

    // Je≈õli u≈ºytkownik jest zalogowany i pr√≥buje wej≈õƒá na stronƒô auth
    if (session && isAuthPath(pathname)) {
      return redirect("/generate");
    }

    // Je≈õli u≈ºytkownik nie jest zalogowany i pr√≥buje wej≈õƒá na chronionƒÖ trasƒô
    if (!session && !isPublicPath(pathname)) {
      return redirect(`/auth/login?redirectTo=${encodeURIComponent(pathname)}`);
    }

    return next();
  }
);
```

---

## üß™ FAZA 9: Testowanie i Debugowanie (2-3 godziny)

### Krok 9.1: Testowanie flow'√≥w autoryzacji

1. **Rejestracja nowego u≈ºytkownika:**

   - Przejd≈∫ do `/auth/register`
   - Wprowad≈∫ email i has≈Ço
   - Sprawd≈∫ czy otrzyma≈Çe≈õ email weryfikacyjny
   - Kliknij link weryfikacyjny

2. **Logowanie z has≈Çem:**

   - Przejd≈∫ do `/auth/login`
   - Wprowad≈∫ dane zarejestrowanego u≈ºytkownika
   - Sprawd≈∫ czy nastƒÖpi≈Ço przekierowanie do `/generate`

3. **Magic Link:**

   - W formularzu logowania kliknij "Zaloguj siƒô magic linkiem"
   - Wprowad≈∫ email
   - Sprawd≈∫ czy otrzyma≈Çe≈õ magic link
   - Kliknij link w emailu

4. **Reset has≈Ça:**

   - Przejd≈∫ do `/auth/forgot-password`
   - Wprowad≈∫ email
   - Sprawd≈∫ czy otrzyma≈Çe≈õ link resetowania
   - Kliknij link i ustaw nowe has≈Ço

5. **Wylogowanie:**
   - Zaloguj siƒô
   - Kliknij menu u≈ºytkownika
   - Wybierz "Wyloguj siƒô"
   - Sprawd≈∫ czy nastƒÖpi≈Ço przekierowanie do logowania

### Krok 9.2: Testowanie RLS

1. **Sprawd≈∫ czy u≈ºytkownik widzi tylko swoje dane:**

   - Zaloguj siƒô jako u≈ºytkownik A
   - Utw√≥rz kilka fiszek
   - Wyloguj siƒô
   - Zaloguj siƒô jako u≈ºytkownik B
   - Sprawd≈∫ czy nie widzi fiszek u≈ºytkownika A

2. **Testuj operacje CRUD:**
   - Utw√≥rz nowƒÖ fiszkƒô
   - Edytuj istniejƒÖcƒÖ fiszkƒô
   - Usu≈Ñ fiszkƒô
   - Sprawd≈∫ czy wszystkie operacje dzia≈ÇajƒÖ poprawnie

### Krok 9.3: Testowanie middleware

1. **Sprawd≈∫ przekierowania dla niezalogowanych:**

   - Wyloguj siƒô
   - Przejd≈∫ do `/generate`
   - Sprawd≈∫ czy nastƒÖpi≈Ço przekierowanie do `/auth/login`

2. **Sprawd≈∫ dostƒôp do chronionych tras:**

   - Zaloguj siƒô
   - Przejd≈∫ do `/generate`
   - Sprawd≈∫ czy masz dostƒôp

3. **Testuj publiczne ≈õcie≈ºki:**
   - Wyloguj siƒô
   - Przejd≈∫ do `/`
   - Sprawd≈∫ czy strona siƒô wy≈õwietla

---

## üîê Bezpiecze≈Ñstwo i Najlepsze Praktyki

### **RLS (Row Level Security)**

- ‚úÖ Wszystkie tabele z danymi u≈ºytkownik√≥w majƒÖ w≈ÇƒÖczone RLS
- ‚úÖ Polityki bazujƒÖ na `auth.uid()` - identyfikator zalogowanego u≈ºytkownika
- ‚úÖ U≈ºytkownicy mogƒÖ operowaƒá tylko na swoich danych

### **Walidacja Danych**

- ‚úÖ Frontend waliduje dane przed wys≈Çaniem
- ‚úÖ Backend (Supabase) waliduje dane na poziomie bazy
- ‚úÖ Typy TypeScript zapewniajƒÖ type safety

### **Sesje i Tokeny**

- ‚úÖ JWT tokeny z automatycznym od≈õwie≈ºaniem
- ‚úÖ Bezpieczne HTTP-only cookies
- ‚úÖ Automatyczne wylogowanie po wyga≈õniƒôciu tokenu

### **Email Security**

- ‚úÖ Weryfikacja email przed dostƒôpem do aplikacji
- ‚úÖ Magic linki z ograniczonym czasem wa≈ºno≈õci
- ‚úÖ Bezpieczne linki resetowania has≈Ça

---

## üì± UX Considerations

### **Loading States**

- ‚úÖ Wszystkie operacje auth majƒÖ loading indicators
- ‚úÖ Disabled buttons podczas ≈Çadowania
- ‚úÖ Progress indicators dla d≈Çugich operacji

### **Error Handling**

- ‚úÖ Jasne komunikaty b≈Çƒôd√≥w
- ‚úÖ Sugestie rozwiƒÖza≈Ñ problem√≥w
- ‚úÖ Graceful fallbacks

### **Responsive Design**

- ‚úÖ Wszystkie formularze dzia≈ÇajƒÖ na mobile
- ‚úÖ Touch-friendly buttons
- ‚úÖ Readable typography na ma≈Çych ekranach

---

## üéØ Podsumowanie i Nastƒôpne Kroki

### **Co zostanie osiƒÖgniƒôte:**

1. ‚úÖ Pe≈Çna autoryzacja email/has≈Ço
2. ‚úÖ Magic link authentication
3. ‚úÖ Reset has≈Ça z weryfikacjƒÖ email
4. ‚úÖ Weryfikacja email po rejestracji
5. ‚úÖ Tabela `profiles` z dodatkowymi danymi
6. ‚úÖ RLS policies dla bezpiecze≈Ñstwa
7. ‚úÖ Integracja UI z backend
8. ‚úÖ Middleware z ochronƒÖ tras

### **Szacowany czas implementacji:**

- **Total**: 12-18 godzin
- **Faza 1-3**: 3-5 godzin (konfiguracja)
- **Faza 4-6**: 5-8 godzin (implementacja)
- **Faza 7-9**: 4-5 godzin (integracja i testy)

### **Nastƒôpne kroki po implementacji:**

1. **Monitoring** - ≈õledzenie b≈Çƒôd√≥w auth
2. **Analytics** - metryki logowa≈Ñ/rejestracji
3. **Social Login** - Google, GitHub (opcjonalnie)
4. **MFA** - dwusk≈Çadnikowa autoryzacja
5. **Advanced RLS** - role i uprawnienia

### **Gotowo≈õƒá do produkcji:**

Po uko≈Ñczeniu tego planu aplikacja bƒôdzie mia≈Ça:

- ‚úÖ ProdukcyjnƒÖ autoryzacjƒô Supabase
- ‚úÖ Bezpieczne RLS policies
- ‚úÖ Kompletny UX dla u≈ºytkownik√≥w
- ‚úÖ Gotowo≈õƒá do skalowania

---

## üìö Przydatne Linki i Dokumentacja

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Supabase RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Supabase TypeScript](https://supabase.com/docs/guides/api/typescript-support)
- [Astro Middleware](https://docs.astro.build/en/guides/middleware/)
- [React Context Best Practices](https://react.dev/learn/passing-data-deeply-with-context)

---

**üéâ Po uko≈Ñczeniu tego planu bƒôdziesz mieƒá w pe≈Çni funkcjonalnƒÖ autoryzacjƒô Supabase w aplikacji 10xCards!**
